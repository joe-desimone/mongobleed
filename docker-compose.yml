services:
  mongodb-vulnerable:
    image: mongo:8.2.2
    container_name: mongobleed-target
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: SuperSecret123!
      MONGO_INITDB_DATABASE: secretdb
    volumes:
      - ./init/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
      - mongodb_data:/data/db
    command: ["mongod", "--networkMessageCompressors", "zlib", "--bind_ip_all"]
    restart: unless-stopped
  tcpdump:
    image: nicolaka/netshoot
    container_name: mongobleed-tcpdump
    network_mode: "service:mongodb-vulnerable"
    cap_add:
      - NET_ADMIN
    command: >
      sh -c 'mkdir -p /pcaps && idx=0;
      while true; do
        tcpdump -n -q -i any port 27017 -U -w "/pcaps/mongo_$$(printf ''%06d'' $$idx).pcap" &&
        idx=$$((idx+1));
      done'
    volumes:
      - ./pcaps:/pcaps
    depends_on:
      - mongodb-vulnerable

volumes:
  mongodb_data:
